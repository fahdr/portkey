---
- name: Apply Talos machine configurations
  hosts: talos
  gather_facts: false
  serial: 1
  vars:
    talos_config_dir: "{{ playbook_dir }}/../talos-configs"

  tasks:
    - name: Determine node type
      ansible.builtin.set_fact:
        node_type: "{{ 'controlplane' if inventory_hostname in groups['talos_masters'] else 'worker' }}"

    - name: Display node configuration
      ansible.builtin.debug:
        msg: "Applying {{ node_type }} configuration to {{ inventory_hostname }} ({{ ansible_host }})"

    - name: Apply Talos machine configuration
      ansible.builtin.command:
        cmd: >
          talosctl apply-config --insecure
          --nodes {{ ansible_host }}
          --file {{ talos_config_dir }}/{{ node_type }}.yaml
          --config-patch @{{ talos_config_dir }}/{{ inventory_hostname }}-patch.yaml
      delegate_to: localhost
      register: apply_result

    - name: Display apply result
      ansible.builtin.debug:
        msg: "Configuration applied to {{ inventory_hostname }}"

    - name: Wait for node to reboot and apply config
      ansible.builtin.pause:
        seconds: 60
        prompt: "Waiting for {{ inventory_hostname }} to apply configuration and reboot..."

    - name: Wait for Talos API to be ready
      ansible.builtin.wait_for:
        host: "{{ ansible_host }}"
        port: 50000
        delay: 10
        timeout: 300
        state: started
      delegate_to: localhost

    - name: Verify node is ready
      ansible.builtin.command:
        cmd: "talosctl --nodes {{ ansible_host }} version"
      delegate_to: localhost
      register: version_check
      retries: 5
      delay: 10
      until: version_check.rc == 0

    - name: Display node version
      ansible.builtin.debug:
        msg: "{{ version_check.stdout }}"

- name: Summary
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Display completion message
      ansible.builtin.debug:
        msg: |
          ========================================
          All Talos configurations applied!

          Next steps:
          1. Bootstrap the cluster:
             talosctl bootstrap --nodes 192.168.0.11 --talosconfig {{ playbook_dir }}/../talos-configs/talosconfig

          2. Get kubeconfig:
             talosctl kubeconfig --nodes 192.168.0.11 --talosconfig {{ playbook_dir }}/../talos-configs/talosconfig

          3. Install Cilium CNI:
             kubectl apply -f https://raw.githubusercontent.com/cilium/cilium/v1.17.4/install/kubernetes/quick-install.yaml

          4. Verify cluster:
             kubectl get nodes
          ========================================
