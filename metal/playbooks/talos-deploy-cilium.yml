---
- name: Deploy Cilium CNI to Talos cluster
  hosts: localhost
  gather_facts: false
  vars:
    cilium_version: "1.17.4"
    kubeconfig: "{{ playbook_dir }}/../kubeconfig.yaml"

  tasks:
    - name: Add Cilium Helm repository
      kubernetes.core.helm_repository:
        name: cilium
        repo_url: https://helm.cilium.io/
        state: present

    - name: Deploy Cilium
      kubernetes.core.helm:
        name: cilium
        chart_ref: cilium/cilium
        chart_version: "{{ cilium_version }}"
        release_namespace: kube-system
        create_namespace: false
        kubeconfig: "{{ kubeconfig }}"
        values:
          k8sServiceHost: 192.168.0.100
          k8sServicePort: "6443"
          operator:
            replicas: 1
          kubeProxyReplacement: true
          waitForKubeProxy: false
          l2announcements:
            enabled: true
          ipam:
            mode: kubernetes
          hubble:
            enabled: false
            relay:
              enabled: false
            ui:
              enabled: false
          tolerations:
            - key: node-role.kubernetes.io/control-plane
              effect: NoSchedule
            - key: node.kubernetes.io/not-ready
              effect: NoSchedule
              operator: Exists
            - key: node.cilium.io/agent-not-ready
              effect: NoSchedule
              operator: Exists
          securityContext:
            capabilities:
              ciliumAgent:
                - CHOWN
                - KILL
                - NET_ADMIN
                - NET_RAW
                - IPC_LOCK
                - SYS_ADMIN
                - SYS_RESOURCE
                - DAC_OVERRIDE
                - FOWNER
                - SETGID
                - SETUID
              cleanCiliumState:
                - NET_ADMIN
                - SYS_ADMIN
                - SYS_RESOURCE
          cgroup:
            autoMount:
              enabled: false
            hostRoot: /sys/fs/cgroup

    - name: Wait for Cilium operator to be ready
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: kube-system
        label_selectors:
          - app.kubernetes.io/name=cilium-operator
        kubeconfig: "{{ kubeconfig }}"
        wait: true
        wait_condition:
          type: Ready
          status: "True"
        wait_timeout: 300

    - name: Wait for Cilium agents to be ready
      kubernetes.core.k8s_info:
        kind: DaemonSet
        name: cilium
        namespace: kube-system
        kubeconfig: "{{ kubeconfig }}"
        wait: true
        wait_condition:
          type: Ready
        wait_timeout: 300

    - name: Display Cilium status
      ansible.builtin.debug:
        msg: "âœ“ Cilium {{ cilium_version }} deployed successfully"
