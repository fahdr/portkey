---
# Install Open WebUI as a Podman container with systemd integration.
# Bazzite comes with Podman pre-installed.

- name: Create Open WebUI data directory
  ansible.builtin.file:
    path: "{{ open_webui_data_dir }}"
    state: directory
    mode: "0755"

- name: Check if Open WebUI container exists
  ansible.builtin.command: podman container inspect open-webui
  register: webui_exists
  failed_when: false
  changed_when: false

- name: Pull Open WebUI image
  ansible.builtin.command: podman pull {{ open_webui_image }}
  when: webui_exists.rc != 0

- name: Create Open WebUI container
  ansible.builtin.command: >
    podman create
    --name open-webui
    --network host
    -v {{ open_webui_data_dir }}:/app/backend/data:Z
    -e OLLAMA_BASE_URL=http://127.0.0.1:11434
    -e PORT={{ open_webui_port }}
    {{ open_webui_image }}
  when: webui_exists.rc != 0

- name: Generate systemd unit for Open WebUI
  ansible.builtin.command: podman generate systemd --new --name open-webui
  register: webui_systemd
  changed_when: false

- name: Install Open WebUI systemd unit
  ansible.builtin.copy:
    content: "{{ webui_systemd.stdout }}"
    dest: /etc/systemd/system/container-open-webui.service
    mode: "0644"

- name: Enable and start Open WebUI service
  ansible.builtin.systemd:
    name: container-open-webui
    state: started
    enabled: true
    daemon_reload: true

- name: Verify Open WebUI is responding
  ansible.builtin.uri:
    url: "http://localhost:{{ open_webui_port }}"
    method: GET
    status_code: [200, 301, 302, 303]
  register: webui_verify
  retries: 10
  delay: 5
  until: webui_verify.status is defined
