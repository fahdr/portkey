---
# Talos configuration settings
talos_version: "{{ hostvars[inventory_hostname].talos_version | default('v1.9.4') }}"
kubernetes_version: "{{ hostvars[inventory_hostname].kubernetes_version | default('v1.33.0') }}"
cluster_name: "portkey-talos"
control_plane_endpoint: "{{ hostvars['localhost'].control_plane_endpoint | default('192.168.0.100') }}"

# Config output directory (one level up from playbooks/)
talos_config_dir: "{{ playbook_dir }}/../talos-configs"
talos_patches_dir: "{{ talos_config_dir }}/patches"

# Network configuration
pod_subnet: "10.0.1.0/8"
service_subnet: "10.43.0.0/16"
dns_servers:
  - "192.168.0.1"  # Gateway/OpnSense with AdGuard
  - "8.8.8.8"  # Fallback
gateway: "192.168.0.1"

# Control plane settings
allow_scheduling_on_control_planes: true  # Allow workloads on control plane (no dedicated workers)

# Feature gates (matching K3s configuration)
api_server_extra_args:
  enable-aggregator-routing: "true"
  feature-gates: "MutatingAdmissionPolicy=true"
  runtime-config: "admissionregistration.k8s.io/v1beta1=true"

# Cert SANs for API server
cert_sans:
  - "{{ control_plane_endpoint }}"
  - "192.168.0.11"  # metal0
  - "192.168.0.12"  # metal1
  - "192.168.0.13"  # metal2

# Kernel modules
kernel_modules:
  - name: i915  # Intel GPU passthrough

# Talos system extensions (via Image Factory)
# To add extensions: add to list, regenerate schematic ID, update talos_image_factory_schematic
# Regenerate: POST https://factory.talos.dev/schematics
# Body: {"customization":{"systemExtensions":{"officialExtensions":["siderolabs/<extension-name>"]}}}
talos_extensions:
  - name: i915-ucode  # Intel GPU firmware/driver

# Image Factory schematic ID (generated from extensions list above)
talos_image_factory_schematic: "ed036d0640097a4e7af413ee089851a12963cd2e2e1715f8866d551d17c2ec62"

# Installer image (uses Image Factory when schematic is set, otherwise vanilla)
talos_installer_image: >-
  {{ 'factory.talos.dev/installer/' + talos_image_factory_schematic + ':' + talos_version
     if talos_image_factory_schematic
     else 'ghcr.io/siderolabs/installer:' + talos_version }}

# Time servers
time_servers:
  - time.cloudflare.com

# Is this node a master?
is_master: "{{ 'talos_masters' in group_names }}"

# Should this node have the VIP?
has_vip: "{{ hostvars[inventory_hostname].talos_vip_enabled | default(false) }}"
