---
# ============================================================
# Root LV Resize (shrink to proxmox_root_size, default 50G)
# ============================================================
# Safely shrinks the Proxmox root ext4 LV using an initramfs
# premount script that runs BEFORE root is mounted.
#
# Strategy: shrink FS to 2G below target → shrink LV → expand
# FS to fill LV.  This ensures the filesystem always fits inside
# the LV even if a step is interrupted.
#
# Safety: refuses to resize if disk usage exceeds target minus
# a 5G safety margin (checked both in Ansible and in initramfs).
#
# Freed space is added to the pve/data thin pool for VM storage.
#
# Set proxmox_root_size in inventory (e.g. "50G") to enable.

- name: Get current root LV size
  ansible.builtin.command:
    cmd: lvs --noheadings --nosuffix --units g -o lv_size pve/root
  register: root_lv_current
  changed_when: false

- name: Get current root disk usage
  ansible.builtin.shell:
    cmd: df --output=used -BG / | tail -1 | tr -d ' G'
  register: root_used_gb
  changed_when: false

- name: Set root size facts
  ansible.builtin.set_fact:
    _root_current_gb: "{{ root_lv_current.stdout | trim | float | int }}"
    _root_target_gb: "{{ proxmox_root_size | regex_replace('[^0-9]', '') | int }}"
    _root_used_gb: "{{ root_used_gb.stdout | trim | int }}"

- name: Root resize decision
  ansible.builtin.debug:
    msg: >-
      Root LV is {{ _root_current_gb }}G ({{ _root_used_gb }}G used),
      target is {{ _root_target_gb }}G.
      {{ 'Resize will proceed.' if (_root_current_gb | int) > ((_root_target_gb | int) + 1)
         and ((_root_used_gb | int) < ((_root_target_gb | int) - 5))
         else 'Already at target — nothing to do.'
         if (_root_current_gb | int) <= ((_root_target_gb | int) + 1)
         else 'UNSAFE: disk usage ' ~ _root_used_gb ~ 'G is too close to target '
         ~ _root_target_gb ~ 'G — refusing to resize.' }}

# Warn and skip if usage is too high
- name: Check if resize is safe
  ansible.builtin.set_fact:
    _resize_safe: "{{ (_root_used_gb | int) < ((_root_target_gb | int) - 5) }}"
    _resize_needed: "{{ (_root_current_gb | int) > ((_root_target_gb | int) + 1) }}"

- name: WARNING — disk usage too high to resize
  ansible.builtin.debug:
    msg: >-
      SKIPPING RESIZE: Root uses {{ _root_used_gb }}G but target is {{ _root_target_gb }}G.
      Need at least 5G free after resize (max safe usage: {{ (_root_target_gb | int) - 5 }}G).
      Either free disk space or increase proxmox_root_size.
  when:
    - _resize_needed | bool
    - not (_resize_safe | bool)

# --- Install initramfs scripts (only if resize needed AND safe) ---

- name: Install initramfs hook (adds resize2fs and e2fsck)
  ansible.builtin.copy:
    dest: /etc/initramfs-tools/hooks/resize-root
    mode: "0755"
    content: |
      #!/bin/sh
      set -e
      . /usr/share/initramfs-tools/hook-functions
      copy_exec /sbin/resize2fs
      copy_exec /sbin/e2fsck
  when: _resize_needed | bool and _resize_safe | bool

- name: Install initramfs premount resize script
  ansible.builtin.copy:
    dest: /etc/initramfs-tools/scripts/local-premount/resize-root
    mode: "0755"
    content: |
      #!/bin/sh
      PREREQ=""
      prereqs() { echo "$PREREQ"; }
      case "$1" in prereqs) prereqs; exit 0 ;; esac

      ROOT_DEV="/dev/pve/root"
      TARGET_GB={{ _root_target_gb }}
      SAFETY_GB=$(( TARGET_GB - 2 ))

      log_msg() { echo "resize-root: $*" > /dev/kmsg 2>/dev/null || true; }

      # Idempotency: skip if already at target
      CURRENT=$(lvm lvs --noheadings --nosuffix --units g -o lv_size pve/root 2>/dev/null \
                | tr -d ' ' | cut -d. -f1)
      if [ "${CURRENT:-0}" -le "$(( TARGET_GB + 1 ))" ]; then
        log_msg "Root LV already ${CURRENT}G (<= ${TARGET_GB}G), skipping"
        exit 0
      fi

      log_msg "=== Resizing root LV: ${CURRENT}G -> ${TARGET_GB}G ==="

      # 1. Filesystem check (required before shrink)
      log_msg "Running e2fsck -f -y ..."
      e2fsck -f -y "$ROOT_DEV" >/dev/null 2>&1 || true
      log_msg "e2fsck done"

      # 2. Shrink FS to safety margin below target
      log_msg "Shrinking filesystem to ${SAFETY_GB}G ..."
      if ! resize2fs "$ROOT_DEV" "${SAFETY_GB}G" >/dev/null 2>&1; then
        log_msg "ERROR: resize2fs shrink FAILED — filesystem too full for ${SAFETY_GB}G"
        log_msg "ABORTING resize to protect data"
        exit 1
      fi
      log_msg "resize2fs shrink done"

      # 3. Shrink LV to target
      log_msg "Shrinking LV to ${TARGET_GB}G ..."
      lvm lvreduce --yes -L "${TARGET_GB}G" "$ROOT_DEV" >/dev/null 2>&1
      log_msg "lvreduce done"

      # 4. Expand FS to fill the LV (recover safety margin)
      log_msg "Expanding filesystem to fill LV ..."
      resize2fs "$ROOT_DEV" >/dev/null 2>&1
      log_msg "resize2fs expand done"

      log_msg "=== Root resize complete ==="
  when: _resize_needed | bool and _resize_safe | bool

- name: Update initramfs with resize scripts
  ansible.builtin.command:
    cmd: update-initramfs -u -k all
  when: _resize_needed | bool and _resize_safe | bool
  register: initramfs_resize

- name: Safe reboot to apply root resize
  ansible.builtin.include_tasks: safe-reboot.yml
  vars:
    _reboot_reason: "Root LV resize from {{ _root_current_gb }}G to {{ _root_target_gb }}G"
  when: initramfs_resize is changed

# --- Post-reboot: verify, extend thin pool, cleanup ---

- name: Verify root LV size
  ansible.builtin.command:
    cmd: lvs --noheadings --nosuffix --units g -o lv_size pve/root
  register: root_lv_after
  changed_when: false

- name: Verify root filesystem
  ansible.builtin.command:
    cmd: df -h /
  register: root_df_after
  changed_when: false

- name: Extend pve/data thin pool with freed space
  ansible.builtin.command:
    cmd: lvm lvextend -l +100%FREE pve/data
  register: extend_result
  failed_when: false
  changed_when: "'successfully resized' in (extend_result.stdout | default(''))"

- name: Verify thin pool size
  ansible.builtin.command:
    cmd: lvs --noheadings --nosuffix --units g -o lv_size pve/data
  register: data_lv_after
  changed_when: false

- name: Remove resize initramfs hook
  ansible.builtin.file:
    path: /etc/initramfs-tools/hooks/resize-root
    state: absent
  register: hook_removed

- name: Remove resize premount script
  ansible.builtin.file:
    path: /etc/initramfs-tools/scripts/local-premount/resize-root
    state: absent
  register: premount_removed

- name: Rebuild initramfs (cleanup)
  ansible.builtin.command:
    cmd: update-initramfs -u -k all
  when: hook_removed is changed or premount_removed is changed

- name: Root resize summary
  ansible.builtin.debug:
    msg: |
      Root LV:    {{ root_lv_after.stdout | trim }}G
      Filesystem: {{ root_df_after.stdout_lines[-1] | default('') }}
      Thin pool:  {{ data_lv_after.stdout | trim }}G
      Extend:     {{ extend_result.stdout | default('no free space to reclaim') | trim }}
