# Fedora Kinoite - Automated Kickstart Install
# Generated by Ansible for {{ vm_name }} on {{ proxmox_node }}
#
# Stage 1 of Bazzite deployment: install Fedora Kinoite as a base,
# then rebase to Bazzite NVIDIA in the post-install playbook.
# Direct Bazzite ISO kickstart is broken (github.com/ublue-os/bazzite/issues/3418).

# System language and keyboard
lang en_US.UTF-8
keyboard us
timezone UTC

# Network — static IP on first virtio interface
network --bootproto=static --device=ens18 --ip={{ bazzite_ip }} --netmask={{ bazzite_netmask }} --gateway={{ bazzite_gateway }} --nameserver={{ bazzite_dns }} --activate --hostname={{ vm_name }}

# Accounts
rootpw --lock
user --name={{ bazzite_user }} --groups=wheel --iscrypted --password={{ bazzite_password_hash }}

# Disk — use entire disk with auto partitioning
clearpart --all --initlabel --disklabel=gpt
autopart

# Fedora ostree (standard Kinoite — has proper SELinux labels)
ostreesetup --osname=fedora --url=file:///ostree/repo --ref=fedora/42/x86_64/kinoite --nogpg

# Power off after install — NOT reboot.
# OVMF warm reboot uses NVRAM boot entries (still ISO-first),
# ignoring the Proxmox boot order config change. Powering off
# forces a cold start which reads the updated boot order (disk-first).
poweroff

# Post-install: enable SSH, deploy key, configure sudo
%post
systemctl enable sshd
echo '{{ bazzite_user }} ALL=(ALL) NOPASSWD:ALL' > /etc/sudoers.d/{{ bazzite_user }}
chmod 440 /etc/sudoers.d/{{ bazzite_user }}
# Deploy Ansible SSH key
mkdir -p /home/{{ bazzite_user }}/.ssh
echo '{{ bazzite_ssh_pubkey }}' > /home/{{ bazzite_user }}/.ssh/authorized_keys
chmod 700 /home/{{ bazzite_user }}/.ssh
chmod 600 /home/{{ bazzite_user }}/.ssh/authorized_keys
chown -R {{ bazzite_user }}:{{ bazzite_user }} /home/{{ bazzite_user }}/.ssh
%end
