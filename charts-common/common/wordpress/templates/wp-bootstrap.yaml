apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-wp-bootstrap
data:
  bootstrap.sh: |
        #!/bin/bash
        if ! command -v wp &> /dev/null; then
            echo "wp-cli not found, installing..."
            curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
            chmod +x wp-cli.phar
            mv wp-cli.phar /usr/local/bin/wp
        fi
        # check if wp-cli is installed
        if ! command -v wp &> /dev/null; then
            /
            echo "wp-cli installation failed, exiting..."
            exit 1
        fi
        WORDPRESS_PATH="/var/www/html"

        WP_CLI=$(command -v /usr/local/bin/wp)
        $WP_CLI --info
        count=0
        until $WP_CLI db check >/dev/null 2>&1; do
            if [ $count -ge 60 ]; then
                echo "Database is not ready after 5 minutes, exiting..."
                exit 1
            fi
            count=$((count + 1))
            echo "Waiting for database to be ready..."
            sleep 5
        done
        if ! $WP_CLI core is-installed 2>/dev/null; then
            $WP_CLI core install --url="${WORDPRESS_URL}" \
                --title="${WORDPRESS_TITLE}" \
                --admin_user="${WORDPRESS_ADMIN_USER}" \
                --admin_password="${WORDPRESS_ADMIN_PASSWORD}" \
                --admin_email="${WORDPRESS_ADMIN_EMAIL}" \
                --skip-email \
                --url="${WORDPRESS_SITE_URL}" \
                --title="${WORDPRESS_BLOG_NAME}"
        fi
        if $WP_CLI core is-installed; then
            $WP_CLI core update-db
        fi
        php-fpm