{{- /* Override the bootstrap ConfigMap from the wordpress chart to fix entrypoint path */ -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-wp-bootstrap
data:
  bootstrap.sh: |
    #!/bin/sh
    set -e

    # Run the WordPress docker entrypoint to set up wp-config.php
    /usr/local/bin/docker-entrypoint.sh php-fpm &
    ENTRYPOINT_PID=$!

    # Wait a moment for entrypoint to complete initial setup
    sleep 5

    # Kill the background php-fpm started by entrypoint (we'll start it properly later)
    kill $ENTRYPOINT_PID 2>/dev/null || true

    WORDPRESS_PATH="/var/www/html"
    WP_CLI="/usr/local/bin/wp"

    # Check if wp-cli is installed
    if ! $WP_CLI --info >/dev/null 2>&1; then
        echo "wp-cli not found at $WP_CLI, checking alternatives..."
        if [ -f /usr/local/bin/wp/wp ]; then
            WP_CLI="/usr/local/bin/wp/wp"
        else
            echo "wp-cli installation failed, exiting..."
            ls -la /usr/local/bin/
            exit 1
        fi
    fi

    echo "Using wp-cli at: $WP_CLI"

    # Note: Database readiness is checked by the init container (wait-for-db)
    # We just need to wait a moment for any connection setup
    echo "Database should be ready (checked by init container), proceeding..."
    sleep 2

    # Install WordPress if not already installed
    if ! $WP_CLI core is-installed --path="${WORDPRESS_PATH}" --allow-root 2>/dev/null; then
        echo "Installing WordPress..."
        $WP_CLI core install \
            --path="${WORDPRESS_PATH}" \
            --allow-root \
            --url="${WORDPRESS_SITE_URL}" \
            --title="${WORDPRESS_BLOG_NAME}" \
            --admin_user="${WORDPRESS_ADMIN_USER}" \
            --admin_password="${WORDPRESS_ADMIN_PASSWORD}" \
            --admin_email="${WORDPRESS_ADMIN_EMAIL}" \
            --skip-email
    else
        echo "WordPress is already installed"
    fi

    # Update database if WordPress is installed
    if $WP_CLI core is-installed --path="${WORDPRESS_PATH}" --allow-root 2>/dev/null; then
        echo "Updating WordPress database..."
        $WP_CLI core update-db --path="${WORDPRESS_PATH}" --allow-root || true
    fi

    echo "Starting PHP-FPM..."
    exec php-fpm
